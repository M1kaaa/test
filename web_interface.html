<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª–∏–Ω—ã –ø–∞—Ç—á-–∫–æ—Ä–¥–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background: white;
            border-radius: 0;
            box-shadow: none;
            padding: 20px 32px 24px;
            width: 100%;
            min-height: 100vh;
            box-sizing: border-box;
        }

        h1 {
            color: #333;
            margin-bottom: 4px;
            font-size: 22px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .server-section {
            background: #f8f9fa;
            padding: 14px 16px;
            border-radius: 10px;
            margin-bottom: 14px;
        }

        .server-section h2 {
            font-size: 15px;
            color: #333;
            margin-bottom: 15px;
        }

        .settings-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .title-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-toggle {
            border: none;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            width: auto;          /* –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
            min-width: 0;
        }

        .settings-toggle span {
            display: none; /* —Å–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç '–ù–∞—Å—Ç—Ä–æ–π–∫–∏' */
        }

        .settings-toggle:hover {
            background: #f3f4ff;
        }

        .config-panel {
            background: #fff3cd;
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid #ffc107;
            display: none;
        }

        .config-panel.open {
            display: block;
        }

        .config-panel h3 {
            font-size: 14px;
            color: #856404;
            margin-bottom: 12px;
        }

        .config-panel label {
            font-size: 13px;
        }

        button {
            width: 100%;
            padding: 10px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .result {
            margin-top: 18px;
            padding: 18px 16px 16px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-radius: 12px;
            color: white;
            text-align: center;
            display: none;
        }

        .result.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .result-value {
            font-size: 26px;
            font-weight: bold;
            margin: 10px 0 5px;
        }

        .result-details {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .segments {
            margin-top: 14px;
            background: rgba(255, 255, 255, 0.12);
            border-radius: 999px;
            padding: 8px;
        }

        .segments-bar {
            display: flex;
            height: 22px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.15);
        }

        .segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            color: #fff;
        }

        .segment-vertical-a {
            background: rgba(255, 255, 255, 0.25);
        }

        .segment-horizontal {
            background: rgba(0, 0, 0, 0.25);
        }

        .segment-vertical-b {
            background: rgba(255, 255, 255, 0.35);
        }

        .segments-legend {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 6px;
            font-size: 11px;
            text-align: left;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 3px 0;
            gap: 6px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }

        .legend-vertical-a {
            background: rgba(255, 255, 255, 0.7);
        }

        .legend-horizontal {
            background: rgba(0, 0, 0, 0.45);
        }

        .legend-vertical-b {
            background: rgba(255, 255, 255, 0.9);
        }

        .result-meta {
            margin-top: 6px;
            font-size: 12px;
            opacity: 0.9;
        }

        .rack-viz {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.12);
            border-radius: 14px;
            padding: 12px;
            overflow: hidden;
        }

        .rack-viz-title {
            font-size: 12px;
            opacity: 0.95;
            margin-bottom: 8px;
            text-align: left;
        }

        .rack-viz svg {
            width: 100%;
            height: 220px;
            display: block;
        }

        .layout-main {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .layout-left {
            flex: 0 0 48%;
        }

        .layout-right {
            flex: 0 0 52%;
        }

        @media (max-width: 900px) {
            .layout-main {
                flex-direction: column;
            }

            .layout-left,
            .layout-right {
                flex: 1 1 100%;
            }
        }

        select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="settings-header">
            <div class="title-row">
                <h1>üîå –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–∞—Ç—á-–∫–æ—Ä–¥–æ–≤</h1>
                <button type="button" class="settings-toggle" id="settingsToggle">
                    ‚öôÔ∏è <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </button>
            </div>
            <p class="subtitle">–†–∞—Å—á—ë—Ç –¥–ª–∏–Ω—ã –∫–∞–±–µ–ª—è –¥–ª—è –∫–æ–º–º—É—Ç–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä–µ</p>
        </div>

        <div class="layout-main">
            <div class="layout-left">
                <form id="calculatorForm">
                    <div class="server-section">
                        <h2>–°–µ—Ä–≤–µ—Ä A</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rack1">–°—Ç–æ–π–∫–∞ (—Ç–æ–ª—å–∫–æ 02b03‚Äì02b18)</label>
                                <select id="rack1" name="rack1" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–π–∫—É</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="unit1">–ù–æ–º–µ—Ä —é–Ω–∏—Ç–∞ (1-50)</label>
                                <input type="number" id="unit1" name="unit1" min="1" max="50" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hostname1">–•–æ—Å—Ç–Ω–µ–π–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                <input type="text" id="hostname1" name="hostname1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, msk-f1111">
                            </div>
                        </div>
                    </div>

                    <div class="server-section">
                        <h2>–°–µ—Ä–≤–µ—Ä B</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rack2">–°—Ç–æ–π–∫–∞ (—Ç–æ–ª—å–∫–æ 02b03‚Äì02b18)</label>
                                <select id="rack2" name="rack2" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–π–∫—É</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="unit2">–ù–æ–º–µ—Ä —é–Ω–∏—Ç–∞ (1-50)</label>
                                <input type="number" id="unit2" name="unit2" min="1" max="50" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hostname2">–•–æ—Å—Ç–Ω–µ–π–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                <input type="text" id="hostname2" name="hostname2" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, msk-f123">
                            </div>
                        </div>
                    </div>

                    <div class="config-panel" id="settingsPanel">
                        <h3>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="slack">–ó–∞–ø–∞—Å –º–µ–∂–¥—É —Å—Ç–æ–π–∫–∞–º–∏ (–º)</label>
                                <input type="number" id="slack" name="slack" min="0" step="0.1" value="0.5">
                            </div>
                            <div class="form-group">
                                <label for="rounding">–®–∞–≥ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è (–º)</label>
                                <input type="number" id="rounding" name="rounding" min="0.1" step="0.1" value="0.5">
                            </div>
                        </div>
                    </div>

                    <button type="submit">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–ª–∏–Ω—É</button>
                </form>
            </div>

            <div class="layout-right">
                <div id="result" class="result">
                    <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞</h3>
                    <div class="result-value" id="resultValue">0.00 –º</div>
                    <div class="result-details" id="resultDetails"></div>
                    <div class="segments" id="segmentsContainer" style="display: none;">
                        <div class="segments-bar" id="segmentsBar">
                            <!-- –°–µ–≥–º–µ–Ω—Ç—ã –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        <div class="segments-legend">
                            <div class="legend-item">
                                <div class="legend-color legend-vertical-a"></div>
                                <span>–í–µ—Ä—Ç–∏–∫–∞–ª—å –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ A –¥–æ –ª–æ—Ç–∫–∞</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color legend-horizontal"></div>
                                <span>–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å –ø–æ –∫–∞–±–µ–ª—å-–∫–∞–Ω–∞–ª—É</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color legend-vertical-b"></div>
                                <span>–í–µ—Ä—Ç–∏–∫–∞–ª—å –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ B –¥–æ –ª–æ—Ç–∫–∞</span>
                            </div>
                        </div>
                        <div class="result-meta" id="resultMeta"></div>

                        <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –∫–∞–±–µ–ª—è (–∫–∞–∫ –Ω–∞ —Å—Ö–µ–º–µ) -->
                        <div class="rack-viz" id="rackVizContainer" style="display: none;">
                            <div class="rack-viz-title" id="rackVizTitle"></div>
                            <svg id="rackViz" viewBox="0 0 760 420" xmlns="http://www.w3.org/2000/svg" aria-label="Rack cable visualization" role="img">
                                <!-- SVG –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:8000";
        const MAX_UNIT = 50; // –í –Ω–∞—à–µ–π –º–æ–¥–µ–ª–∏ 1..50

        async function loadRacks() {
            try {
                const res = await fetch(`${API_BASE}/racks`);
                if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å—Ç–æ–µ–∫");
                const data = await res.json();

                const rackSelects = [
                    document.getElementById("rack1"),
                    document.getElementById("rack2"),
                ];

                data.racks.forEach((rack) => {
                    rackSelects.forEach((select) => {
                        const option = document.createElement("option");
                        option.value = rack.code;
                        option.textContent = rack.code; // –±–µ–∑ "–ø–æ–∑–∏—Ü–∏—è N", —á—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –±—ã–ª –∫–æ—Ä–æ—á–µ
                        select.appendChild(option);
                    });
                });
            } catch (err) {
                console.error(err);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–∞–Ω —Å—Ç–æ–µ–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ API /racks –∑–∞–ø—É—â–µ–Ω.");
            }
        }

        function updateSegmentsVisualization(breakdown) {
            const { vertical_a_m, vertical_b_m, horizontal_m, raw_total_m, slack_added_m, same_rack } =
                breakdown;

            const segmentsContainer = document.getElementById("segmentsContainer");
            const segmentsBar = document.getElementById("segmentsBar");
            const resultMeta = document.getElementById("resultMeta");

            if (raw_total_m <= 0) {
                segmentsContainer.style.display = "none";
                return;
            }

            const total = raw_total_m;
            const vA = Math.max(vertical_a_m, 0);
            const vB = Math.max(vertical_b_m, 0);
            const h = Math.max(horizontal_m, 0);

            const pct = (value) => (value / total) * 100;

            segmentsBar.innerHTML = "";

            if (vA > 0.001) {
                const segA = document.createElement("div");
                segA.className = "segment segment-vertical-a";
                segA.style.width = `${pct(vA)}%`;
                segA.textContent = `${vA.toFixed(2)} –º`;
                segmentsBar.appendChild(segA);
            }

            if (h > 0.001) {
                const segH = document.createElement("div");
                segH.className = "segment segment-horizontal";
                segH.style.width = `${pct(h)}%`;
                segH.textContent = `${h.toFixed(2)} –º`;
                segmentsBar.appendChild(segH);
            }

            if (vB > 0.001) {
                const segB = document.createElement("div");
                segB.className = "segment segment-vertical-b";
                segB.style.width = `${pct(vB)}%`;
                segB.textContent = `${vB.toFixed(2)} –º`;
                segmentsBar.appendChild(segB);
            }

            if (!same_rack && slack_added_m > 0.0001) {
                resultMeta.textContent =
                    `–ë–µ–∑ –∑–∞–ø–∞—Å–∞: ${raw_total_m.toFixed(2)} –º, ` +
                    `–¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø–∞—Å –º–µ–∂–¥—É —Å—Ç–æ–π–∫–∞–º–∏: ${slack_added_m.toFixed(2)} –º`;
            } else {
                resultMeta.textContent = `–ë–µ–∑ –∑–∞–ø–∞—Å–∞: ${raw_total_m.toFixed(2)} –º, –∑–∞–ø–∞—Å –Ω–µ –¥–æ–±–∞–≤–ª—è–ª—Å—è`;
            }

            segmentsContainer.style.display = "block";
        }

        function svgEl(tag, attrs = {}) {
            const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
            Object.entries(attrs).forEach(([k, v]) => el.setAttribute(k, String(v)));
            return el;
        }

        function clamp(n, min, max) {
            return Math.max(min, Math.min(max, n));
        }

        function renderRackVisualization(data) {
            const rackVizContainer = document.getElementById("rackVizContainer");
            const rackViz = document.getElementById("rackViz");
            const rackVizTitle = document.getElementById("rackVizTitle");

            // –û—á–∏—â–∞–µ–º
            rackViz.innerHTML = "";

            const rackA = data.server_a.rack_code;
            const rackB = data.server_b.rack_code;
            const unitA = data.server_a.unit;
            const unitB = data.server_b.unit;
            const sameRack = data.same_rack;

            // –ì–µ–æ–º–µ—Ç—Ä–∏—è SVG
            const W = 760, H = 420;
            const rackW = 170;
            const rackH = 320; // –≤—ã—Å–æ—Ç–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è MAX_UNIT
            const topY = 60;
            const leftX = 170;
            const rightX = 420;
            const unitPx = rackH / MAX_UNIT;

            // "–ö–∞–±–µ–ª—å-–∫–∞–Ω–∞–ª" (–ª–æ—Ç–æ–∫) ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è —Å–≤–µ—Ä—Ö—É
            const trayY = topY - 18;

            // –ü–æ–º–æ—â–Ω–∏–∫: y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ —Ü–µ–Ω—Ç—Ä–∞ —é–Ω–∏—Ç–∞ (1 ‚Äî –Ω–∏–∑, MAX_UNIT ‚Äî –≤–µ—Ä—Ö)
            const unitToY = (unit) => {
                const u = clamp(unit, 1, MAX_UNIT);
                // unit=MAX_UNIT -> y ~ topY + unitPx/2, unit=1 -> y ~ topY + rackH - unitPx/2
                return topY + (MAX_UNIT - u) * unitPx + unitPx / 2;
            };

            const yA = unitToY(unitA);
            const yB = unitToY(unitB);

            // –§–æ–Ω
            rackViz.appendChild(svgEl("rect", { x: 0, y: 0, width: W, height: H, fill: "rgba(255,255,255,0.0)" }));

            // –ü–æ–¥–ø–∏—Å–∏ —Å—Ç–æ–µ–∫
            rackViz.appendChild(
                svgEl("text", {
                    x: leftX + rackW / 2,
                    y: 28,
                    "text-anchor": "middle",
                    fill: "#fff",
                    "font-size": 16,
                    "font-weight": 700,
                }),
            ).appendChild(document.createTextNode(rackA));

            if (!sameRack) {
                rackViz.appendChild(
                    svgEl("text", {
                        x: rightX + rackW / 2,
                        y: 28,
                        "text-anchor": "middle",
                        fill: "#fff",
                        "font-size": 16,
                        "font-weight": 700,
                    }),
                ).appendChild(document.createTextNode(rackB));
            }

            // –õ–æ—Ç–æ–∫ / –∫–∞–±–µ–ª—å-–∫–∞–Ω–∞–ª
            rackViz.appendChild(svgEl("line", { x1: leftX - 30, y1: trayY, x2: rightX + rackW + 30, y2: trayY, stroke: "rgba(255,255,255,0.65)", "stroke-width": 4, "stroke-linecap": "round" }));
            rackViz.appendChild(svgEl("text", { x: (leftX + rightX + rackW) / 2, y: trayY - 10, "text-anchor": "middle", fill: "rgba(255,255,255,0.85)", "font-size": 12 }))
                .appendChild(document.createTextNode("–∫–∞–±–µ–ª—å‚Äë–∫–∞–Ω–∞–ª"));

            // –†–∏—Å—É–µ–º —Å—Ç–æ–π–∫–∏ (–∫–æ–Ω—Ç—É—Ä)
            const rackStyle = { fill: "rgba(255,255,255,0.10)", stroke: "rgba(255,255,255,0.55)", "stroke-width": 2, rx: 10, ry: 10 };
            rackViz.appendChild(svgEl("rect", { x: leftX, y: topY, width: rackW, height: rackH, ...rackStyle }));
            if (!sameRack) {
                rackViz.appendChild(svgEl("rect", { x: rightX, y: topY, width: rackW, height: rackH, ...rackStyle }));
            }

            // –¢–∏–∫–∏ —é–Ω–∏—Ç–æ–≤ (–∫–∞–∂–¥—ã–µ 5U)
            for (let u = 5; u <= MAX_UNIT; u += 5) {
                const y = unitToY(u);
                // –ª–µ–≤—ã–π
                rackViz.appendChild(svgEl("line", { x1: leftX - 8, y1: y, x2: leftX, y2: y, stroke: "rgba(255,255,255,0.45)", "stroke-width": 1 }));
                rackViz.appendChild(
                    svgEl("text", {
                        x: leftX - 12,
                        y: y + 4,
                        "text-anchor": "end",
                        fill: "rgba(255,255,255,0.65)",
                        "font-size": 10,
                    }),
                ).appendChild(document.createTextNode(String(u)));

                if (!sameRack) {
                    // –ø—Ä–∞–≤—ã–π
                    rackViz.appendChild(svgEl("line", { x1: rightX + rackW, y1: y, x2: rightX + rackW + 8, y2: y, stroke: "rgba(255,255,255,0.45)", "stroke-width": 1 }));
                    rackViz.appendChild(
                        svgEl("text", {
                            x: rightX + rackW + 12,
                            y: y + 4,
                            "text-anchor": "start",
                            fill: "rgba(255,255,255,0.65)",
                            "font-size": 10,
                        }),
                    ).appendChild(document.createTextNode(String(u)));
                }
            }

            // –ú–∞—Ä–∫–µ—Ä—ã —Ç–æ—á–µ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ (A –∏ B) ‚Äî –≤ —Ü–µ–Ω—Ç—Ä–µ —Å—Ç–æ–π–∫–∏,
            // –∞ –∫–∞–±–µ–ª—å –≤–Ω—É—Ç—Ä–∏ —Å—Ç–æ–π–∫–∏ –∏–¥—ë—Ç –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é (–∫–∞–∫ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ).
            // alignLeft: true  ‚Üí —Ç–µ–∫—Å—Ç —Å–ø—Ä–∞–≤–∞ –æ—Ç —Ç–æ—á–∫–∏
            // alignLeft: false ‚Üí —Ç–µ–∫—Å—Ç —Å–ª–µ–≤–∞ –æ—Ç —Ç–æ—á–∫–∏
            // dy: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–¥–≤–∏–≥ –ø–æ–¥–ø–∏—Å–∏ (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –ª–∏–Ω–∏—é –∫–∞–±–µ–ª—è)
            const marker = (cx, cy, label, alignLeft = true, dy = 0) => {
                rackViz.appendChild(svgEl("circle", { cx, cy, r: 6, fill: "#ff4d4d" }));
                const textX = alignLeft ? cx + 10 : cx - 10;
                const anchor = alignLeft ? "start" : "end";
                rackViz.appendChild(svgEl("text", {
                    x: textX,
                    y: cy + 4 + dy,
                    fill: "#fff",
                    "font-size": 12,
                    "font-weight": 700,
                    "text-anchor": anchor,
                })).appendChild(document.createTextNode(label));
            };

            // –ö–∞–±–µ–ª—å –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π —Å—Ç–æ–π–∫–∏ –∏–¥—ë—Ç –ø–æ –ü–†–ê–í–û–ô —Å—Ç–æ—Ä–æ–Ω–µ —Å—Ç–æ–π–∫–∏,
            // –∞ —Å–µ—Ä–≤–µ—Ä—ã —Ä–∏—Å—É–µ–º –ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å—Ç–æ–µ–∫.
            const cableXLeftRack = leftX + rackW - 8; // –ª–∏–Ω–∏—è –∫–∞–±–µ–ª—è –≤–¥–æ–ª—å –ø—Ä–∞–≤–æ–π —Å—Ç–µ–Ω–∫–∏ –ª–µ–≤–æ–π —Å—Ç–æ–π–∫–∏
            const cableXRightRack = rightX + rackW - 8; // –ª–∏–Ω–∏—è –∫–∞–±–µ–ª—è –≤–¥–æ–ª—å –ø—Ä–∞–≤–æ–π —Å—Ç–µ–Ω–∫–∏ –ø—Ä–∞–≤–æ–π —Å—Ç–æ–π–∫–∏

            const serverXLeft = leftX + rackW / 2;
            let serverXRight = null;

            if (sameRack) {
                // –û–±–∞ —Å–µ—Ä–≤–µ—Ä–∞ –≤ –æ–¥–Ω–æ–π —Å—Ç–æ–π–∫–µ.
                // –ß—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å–∏ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∏—Å—å –∫–∞–±–µ–ª–µ–º,
                // —É A —Ç–µ–∫—Å—Ç —Ä–∏—Å—É–µ–º —Å–ª–µ–≤–∞ –æ—Ç —Ç–æ—á–∫–∏, —É B ‚Äî —Å–ª–µ–≤–∞ –∏ —á—É—Ç—å –≤—ã—à–µ –ª–∏–Ω–∏–∏.
                marker(serverXLeft, yA, `A (${unitA}U)`, false);
                marker(serverXLeft, yB, `B (${unitB}U)`, false, -10);
            } else {
                serverXRight = rightX + rackW / 2;
                marker(serverXLeft, yA, `A (${unitA}U)`, true);
                marker(serverXRight, yB, `B (${unitB}U)`, false);
            }

            // –ö—Ä–∞—Å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –∫–∞–±–µ–ª—è
            const pathColor = "#ff4d4d";
            const pathWidth = 6;

            if (data.same_rack) {
                // –û–¥–Ω–∞ —Å—Ç–æ–π–∫–∞: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ –ø—Ä–∞–≤–æ–π —Å—Ç–µ–Ω–∫–∏,
                // –∑–∞—Ç–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ –≤–¥–æ–ª—å –ø—Ä–∞–≤–æ–π —Å—Ç–µ–Ω–∫–∏ –º–µ–∂–¥—É —é–Ω–∏—Ç–∞–º–∏.
                const xCable = cableXLeftRack;

                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ A –¥–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –∫–∞–±–µ–ª—è
                rackViz.appendChild(
                    svgEl("line", {
                        x1: serverXLeft,
                        y1: yA,
                        x2: xCable,
                        y2: yA,
                        stroke: pathColor,
                        "stroke-width": pathWidth,
                        "stroke-linecap": "round",
                    }),
                );

                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ –ø–æ –ø—Ä–∞–≤–æ–π —Å—Ç–æ—Ä–æ–Ω–µ —Å—Ç–æ–π–∫–∏
                rackViz.appendChild(
                    svgEl("line", {
                        x1: xCable,
                        y1: yA,
                        x2: xCable,
                        y2: yB,
                        stroke: pathColor,
                        "stroke-width": pathWidth,
                        "stroke-linecap": "round",
                    }),
                );

                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ –æ—Ç –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –∫–∞–±–µ–ª—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ B ‚Äî
                // —á—Ç–æ–±—ã —Ç–æ—á–∫–∞ B —Ç–∞–∫–∂–µ –±—ã–ª–∞ "–ø–æ–¥–≤–µ—à–µ–Ω–∞" –∫ –∫—Ä–∞—Å–Ω–æ–º—É –∫–∞–±–µ–ª—é.
                rackViz.appendChild(
                    svgEl("line", {
                        x1: xCable,
                        y1: yB,
                        x2: serverXLeft,
                        y2: yB,
                        stroke: pathColor,
                        "stroke-width": pathWidth,
                        "stroke-linecap": "round",
                    }),
                );

                const midY = (yA + yB) / 2;
                rackViz.appendChild(
                    svgEl("text", {
                        x: xCable + 14,
                        y: midY + 6,
                        fill: "#fff",
                        "font-size": 20,
                        "font-weight": 800,
                        "text-anchor": "start",
                    }),
                ).appendChild(document.createTextNode(`${data.vertical_a_m.toFixed(2)} –º`));

                rackVizTitle.textContent = "–ú–∞—Ä—à—Ä—É—Ç –∫–∞–±–µ–ª—è –≤–Ω—É—Ç—Ä–∏ —Å—Ç–æ–π–∫–∏ (–≤–ø—Ä–∞–≤–æ ‚Üí –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑)";
            } else {
                // –†–∞–∑–Ω—ã–µ —Å—Ç–æ–π–∫–∏: –≤–≤–µ—Ä—Ö –¥–æ –ª–æ—Ç–∫–∞, –ø–æ –ª–æ—Ç–∫—É, –≤–Ω–∏–∑.
                // –í–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π —Å—Ç–æ–π–∫–∏: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å –¥–æ –ø—Ä–∞–≤–æ–π —Å—Ç–µ–Ω–∫–∏, –∑–∞—Ç–µ–º –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑.
                const upX = cableXLeftRack;
                const downX = cableXRightRack;

                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ –≤–Ω—É—Ç—Ä–∏ –ª–µ–≤–æ–π —Å—Ç–æ–π–∫–∏ (–æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ –∫–∞–±–µ–ª—å–Ω–æ–π –≤–µ—Ä—Ç–∏–∫–∞–ª–∏)
                rackViz.appendChild(
                    svgEl("line", {
                        x1: serverXLeft,
                        y1: yA,
                        x2: upX,
                        y2: yA,
                        stroke: pathColor,
                        "stroke-width": pathWidth,
                        "stroke-linecap": "round",
                    }),
                );

                // –í–≤–µ—Ä—Ö (A -> tray) –ø–æ –ø—Ä–∞–≤–æ–π —Å—Ç–æ—Ä–æ–Ω–µ –ª–µ–≤–æ–π —Å—Ç–æ–π–∫–∏
                rackViz.appendChild(
                    svgEl("line", {
                        x1: upX,
                        y1: yA,
                        x2: upX,
                        y2: trayY,
                        stroke: pathColor,
                        "stroke-width": pathWidth,
                        "stroke-linecap": "round",
                    }),
                );
                rackViz.appendChild(
                    svgEl("text", {
                        x: upX - 10,
                        y: (yA + trayY) / 2 + 2,
                        fill: "#fff",
                        "font-size": 20,
                        "font-weight": 800,
                        "text-anchor": "end",
                    }),
                ).appendChild(document.createTextNode(`${data.vertical_a_m.toFixed(2)} –º`));

                // –ü–æ –ª–æ—Ç–∫—É (–º–µ–∂–¥—É —Å—Ç–æ–π–∫–∞–º–∏)
                rackViz.appendChild(
                    svgEl("line", {
                        x1: upX,
                        y1: trayY,
                        x2: downX,
                        y2: trayY,
                        stroke: pathColor,
                        "stroke-width": pathWidth,
                        "stroke-linecap": "round",
                    }),
                );
                rackViz.appendChild(
                    svgEl("text", {
                        x: (upX + downX) / 2,
                        y: trayY - 20,
                        fill: "#fff",
                        "font-size": 20,
                        "font-weight": 800,
                        "text-anchor": "middle",
                    }),
                ).appendChild(document.createTextNode(`${data.horizontal_m.toFixed(2)} –º`));

                // –í–Ω–∏–∑ (tray -> B) –ø–æ –ø—Ä–∞–≤–æ–π —Å—Ç–æ—Ä–æ–Ω–µ –ø—Ä–∞–≤–æ–π —Å—Ç–æ–π–∫–∏
                rackViz.appendChild(
                    svgEl("line", {
                        x1: downX,
                        y1: trayY,
                        x2: downX,
                        y2: yB,
                        stroke: pathColor,
                        "stroke-width": pathWidth,
                        "stroke-linecap": "round",
                    }),
                );
                rackViz.appendChild(
                    svgEl("text", {
                        x: downX + 10,
                        y: (yB + trayY) / 2 + 2,
                        fill: "#fff",
                        "font-size": 20,
                        "font-weight": 800,
                        "text-anchor": "start",
                    }),
                ).appendChild(document.createTextNode(`${data.vertical_b_m.toFixed(2)} –º`));

                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∞–≤–æ–π —Å—Ç–æ–π–∫–∏ (–æ—Ç –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞)
                rackViz.appendChild(
                    svgEl("line", {
                        x1: downX,
                        y1: yB,
                        x2: serverXRight,
                        y2: yB,
                        stroke: pathColor,
                        "stroke-width": pathWidth,
                        "stroke-linecap": "round",
                    }),
                );

                // –û—Ç–º–µ—Ç–∏–º, —á—Ç–æ –∑–∞–ø–∞—Å –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                if (data.slack_added_m && data.slack_added_m > 0.0001) {
                    rackViz.appendChild(svgEl("text", { x: (leftX + rightX + rackW) / 2, y: H - 22, fill: "rgba(255,255,255,0.95)", "font-size": 12, "text-anchor": "middle" }))
                        .appendChild(document.createTextNode(`+ –∑–∞–ø–∞—Å: ${data.slack_added_m.toFixed(2)} –º (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –º–µ–∂–¥—É —Å—Ç–æ–π–∫–∞–º–∏)`));
                }

                rackVizTitle.textContent = "–ú–∞—Ä—à—Ä—É—Ç –∫–∞–±–µ–ª—è: –≤–≤–µ—Ä—Ö ‚Üí –ø–æ –∫–∞–±–µ–ª—å‚Äë–∫–∞–Ω–∞–ª—É ‚Üí –≤–Ω–∏–∑";
            }

            rackVizContainer.style.display = "block";
        }

        document.getElementById("calculatorForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const rackCodeA = document.getElementById("rack1").value;
            const rackCodeB = document.getElementById("rack2").value;
            const unitA = parseInt(document.getElementById("unit1").value, 10);
            const unitB = parseInt(document.getElementById("unit2").value, 10);
            const hostnameA = (document.getElementById("hostname1").value || "").trim();
            const hostnameB = (document.getElementById("hostname2").value || "").trim();

            const slack = parseFloat(document.getElementById("slack").value);
            const rounding = parseFloat(document.getElementById("rounding").value);

            if (!rackCodeA || !rackCodeB) {
                alert("–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ —Å—Ç–æ–π–∫–∏ –∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 02b03‚Äì02b18.");
                return;
            }

            if (
                Number.isNaN(unitA) ||
                Number.isNaN(unitB) ||
                unitA < 1 ||
                unitA > 50 ||
                unitB < 1 ||
                unitB > 50
            ) {
                alert("–ù–æ–º–µ—Ä —é–Ω–∏—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 50.");
                return;
            }

            const payload = {
                server_a: { rack_code: rackCodeA, unit: unitA, hostname: hostnameA || undefined },
                server_b: { rack_code: rackCodeB, unit: unitB, hostname: hostnameB || undefined },
                config: {
                    cross_rack_slack_m: slack,
                    rounding_step_m: rounding,
                },
            };

            try {
                const res = await fetch(`${API_BASE}/calculate`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.detail || "–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞");
                }

                const data = await res.json();

                document.getElementById("resultValue").textContent =
                    data.length_m.toFixed(2) + " –º";

                const hostA = data.server_a.hostname ? ` (${data.server_a.hostname})` : "";
                const hostB = data.server_b.hostname ? ` (${data.server_b.hostname})` : "";

                const details =
                    `–°–µ—Ä–≤–µ—Ä A: –°—Ç–æ–π–∫–∞ ${data.server_a.rack_code}, –Æ–Ω–∏—Ç ${data.server_a.unit}${hostA} ‚Üí ` +
                    `–°–µ—Ä–≤–µ—Ä B: –°—Ç–æ–π–∫–∞ ${data.server_b.rack_code}, –Æ–Ω–∏—Ç ${data.server_b.unit}${hostB}`;
                document.getElementById("resultDetails").textContent = details;

                updateSegmentsVisualization(data);
                renderRackVisualization(data);

                const resultDiv = document.getElementById("result");
                resultDiv.classList.add("show");
                resultDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
            } catch (err) {
                console.error(err);
                alert(err.message || "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ.");
            }
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç–æ–µ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadRacks();

        // –õ–æ–≥–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        const settingsToggle = document.getElementById("settingsToggle");
        const settingsPanel = document.getElementById("settingsPanel");
        settingsToggle.addEventListener("click", () => {
            settingsPanel.classList.toggle("open");
        });
    </script>
</body>
</html>
